# é˜¶æ®µ3å®æ–½è®¡åˆ’ï¼šæ•°æ®æŒä¹…åŒ–ä¸ç»Ÿè®¡ç³»ç»Ÿ

## ğŸ¯ é˜¶æ®µ3ç›®æ ‡

åŸºäºå‰ä¸¤ä¸ªé˜¶æ®µçš„æˆæœï¼Œç°åœ¨ä¸“æ³¨äºæ•°æ®ç®¡ç†å’Œç”¨æˆ·ä½“éªŒçš„æ·±åº¦ä¼˜åŒ–ï¼š
- å®ç°è·¨å¹³å°æ•°æ®æŒä¹…åŒ–ç³»ç»Ÿ
- åˆ›å»ºå®Œæ•´çš„æ¸¸æˆç»Ÿè®¡å’Œåˆ†æåŠŸèƒ½
- å¼€å‘æˆå°±ç³»ç»Ÿå’Œæ’è¡Œæ¦œ
- å®ç°æ¸¸æˆå›æ”¾å’Œæ•°æ®å¯¼å‡ºåŠŸèƒ½

## ğŸ“‹ è¯¦ç»†ä»»åŠ¡æ¸…å•

### 3.1 æ•°æ®æŒä¹…åŒ–ç³»ç»Ÿå¼€å‘ (2-3å¤©)

#### æ ¸å¿ƒå­˜å‚¨ç»„ä»¶
- [ ] `PlatformStorage.kt` - è·¨å¹³å°å­˜å‚¨æŠ½è±¡
- [ ] `GameDataRepository.kt` - æ•°æ®ä»“åº“æ¨¡å¼å®ç°
- [ ] `SettingsRepository.kt` - è®¾ç½®æ•°æ®ç®¡ç†
- [ ] `StatisticsRepository.kt` - ç»Ÿè®¡æ•°æ®ç®¡ç†

#### æ•°æ®æ¨¡å‹è®¾è®¡
- [ ] `GameRecord.kt` - æ¸¸æˆè®°å½•æ•°æ®æ¨¡å‹
- [ ] `PlayerStatistics.kt` - ç©å®¶ç»Ÿè®¡æ•°æ®
- [ ] `Achievement.kt` - æˆå°±æ•°æ®æ¨¡å‹
- [ ] `LeaderboardEntry.kt` - æ’è¡Œæ¦œæ¡ç›®

### 3.2 ç»Ÿè®¡ç³»ç»Ÿå¼€å‘ (2-3å¤©)

#### ç»Ÿè®¡åˆ†æç»„ä»¶
- [ ] `StatisticsManager.kt` - ç»Ÿè®¡æ•°æ®ç®¡ç†å™¨
- [ ] `GameAnalyzer.kt` - æ¸¸æˆæ•°æ®åˆ†æå™¨
- [ ] `PerformanceTracker.kt` - æ€§èƒ½è¿½è¸ªå™¨
- [ ] `TrendAnalyzer.kt` - è¶‹åŠ¿åˆ†æå™¨

#### ç»Ÿè®¡ç•Œé¢
- [ ] `StatisticsScreen.kt` - ç»Ÿè®¡ä¸»ç•Œé¢
- [ ] `ChartComponents.kt` - å›¾è¡¨ç»„ä»¶
- [ ] `StatisticsCards.kt` - ç»Ÿè®¡å¡ç‰‡ç»„ä»¶
- [ ] `FilterControls.kt` - ç­›é€‰æ§åˆ¶ç»„ä»¶

### 3.3 æˆå°±ç³»ç»Ÿå¼€å‘ (2å¤©)

#### æˆå°±æ ¸å¿ƒç»„ä»¶
- [ ] `AchievementManager.kt` - æˆå°±ç®¡ç†å™¨
- [ ] `AchievementChecker.kt` - æˆå°±æ£€æŸ¥å™¨
- [ ] `AchievementDefinitions.kt` - æˆå°±å®šä¹‰
- [ ] `AchievementNotification.kt` - æˆå°±é€šçŸ¥

#### æˆå°±ç•Œé¢
- [ ] `AchievementsScreen.kt` - æˆå°±ç•Œé¢
- [ ] `AchievementCard.kt` - æˆå°±å¡ç‰‡
- [ ] `ProgressIndicator.kt` - è¿›åº¦æŒ‡ç¤ºå™¨
- [ ] `UnlockAnimation.kt` - è§£é”åŠ¨ç”»

### 3.4 æ’è¡Œæ¦œç³»ç»Ÿå¼€å‘ (2å¤©)

#### æ’è¡Œæ¦œç»„ä»¶
- [ ] `LeaderboardManager.kt` - æ’è¡Œæ¦œç®¡ç†å™¨
- [ ] `ScoreCalculator.kt` - åˆ†æ•°è®¡ç®—å™¨
- [ ] `RankingSystem.kt` - æ’åç³»ç»Ÿ
- [ ] `LeaderboardSync.kt` - æ•°æ®åŒæ­¥(æœ¬åœ°)

#### æ’è¡Œæ¦œç•Œé¢
- [ ] `LeaderboardScreen.kt` - æ’è¡Œæ¦œç•Œé¢
- [ ] `RankingList.kt` - æ’ååˆ—è¡¨
- [ ] `PlayerRankCard.kt` - ç©å®¶æ’åå¡ç‰‡
- [ ] `FilterTabs.kt` - ç­›é€‰æ ‡ç­¾

### 3.5 æ•°æ®å¯¼å‡ºå’Œå›æ”¾ç³»ç»Ÿ (1-2å¤©)

#### å›æ”¾ç³»ç»Ÿ
- [ ] `GameRecorder.kt` - æ¸¸æˆå½•åˆ¶å™¨
- [ ] `GameReplayer.kt` - æ¸¸æˆå›æ”¾å™¨
- [ ] `ReplayData.kt` - å›æ”¾æ•°æ®æ¨¡å‹
- [ ] `ReplayControls.kt` - å›æ”¾æ§åˆ¶ç»„ä»¶

#### æ•°æ®å¯¼å‡º
- [ ] `DataExporter.kt` - æ•°æ®å¯¼å‡ºå™¨
- [ ] `ReportGenerator.kt` - æŠ¥å‘Šç”Ÿæˆå™¨
- [ ] `ShareManager.kt` - åˆ†äº«ç®¡ç†å™¨

## ğŸ› ï¸ æŠ€æœ¯å®ç°è¦ç‚¹

### è·¨å¹³å°å­˜å‚¨æ¶æ„
```kotlin
// å­˜å‚¨æŠ½è±¡æ¥å£
expect class PlatformStorage {
    fun saveString(key: String, value: String)
    fun getString(key: String, defaultValue: String): String
    fun saveInt(key: String, value: Int)
    fun getInt(key: String, defaultValue: Int): Int
    fun saveLong(key: String, value: Long)
    fun getLong(key: String, defaultValue: Long): Long
    fun saveBoolean(key: String, value: Boolean)
    fun getBoolean(key: String, defaultValue: Boolean): Boolean
    fun remove(key: String)
    fun clear()
}

// Androidå®ç°
actual class PlatformStorage(private val context: Context) {
    private val prefs = context.getSharedPreferences("snake_game", Context.MODE_PRIVATE)
    
    actual fun saveString(key: String, value: String) {
        prefs.edit().putString(key, value).apply()
    }
    
    actual fun getString(key: String, defaultValue: String): String {
        return prefs.getString(key, defaultValue) ?: defaultValue
    }
}

// iOSå®ç°
actual class PlatformStorage {
    actual fun saveString(key: String, value: String) {
        NSUserDefaults.standardUserDefaults.setObject(value, key)
    }
    
    actual fun getString(key: String, defaultValue: String): String {
        return NSUserDefaults.standardUserDefaults.stringForKey(key) ?: defaultValue
    }
}
```

### æ•°æ®ä»“åº“æ¨¡å¼
```kotlin
// æ•°æ®ä»“åº“æ¥å£
interface GameDataRepository {
    suspend fun saveGameRecord(record: GameRecord)
    suspend fun getGameRecords(limit: Int = 100): List<GameRecord>
    suspend fun getPlayerStatistics(): PlayerStatistics
    suspend fun updateStatistics(statistics: PlayerStatistics)
    suspend fun clearAllData()
}

// å®ç°ç±»
class GameDataRepositoryImpl(
    private val storage: PlatformStorage,
    private val jsonSerializer: Json
) : GameDataRepository {
    
    override suspend fun saveGameRecord(record: GameRecord) {
        val records = getGameRecords().toMutableList()
        records.add(0, record) // æ·»åŠ åˆ°å¼€å¤´
        
        // ä¿æŒæœ€å¤š1000æ¡è®°å½•
        if (records.size > 1000) {
            records.removeAt(records.size - 1)
        }
        
        val json = jsonSerializer.encodeToString(records)
        storage.saveString(KEY_GAME_RECORDS, json)
    }
    
    override suspend fun getGameRecords(limit: Int): List<GameRecord> {
        val json = storage.getString(KEY_GAME_RECORDS, "[]")
        val records = jsonSerializer.decodeFromString<List<GameRecord>>(json)
        return records.take(limit)
    }
}
```

### ç»Ÿè®¡åˆ†æç³»ç»Ÿ
```kotlin
// ç»Ÿè®¡æ•°æ®æ¨¡å‹
data class PlayerStatistics(
    val totalGames: Int = 0,
    val totalScore: Long = 0,
    val highestScore: Int = 0,
    val totalPlayTime: Long = 0, // æ¯«ç§’
    val averageScore: Double = 0.0,
    val gamesWon: Int = 0,
    val longestSnake: Int = 0,
    val foodEaten: Int = 0,
    val effectsUsed: Int = 0,
    val gamesByMode: Map<GameMode, Int> = emptyMap(),
    val gamesByDifficulty: Map<Difficulty, Int> = emptyMap(),
    val dailyStats: Map<String, DailyStats> = emptyMap(), // æ—¥æœŸ -> ç»Ÿè®¡
    val achievements: Set<String> = emptySet()
)

// ç»Ÿè®¡ç®¡ç†å™¨
class StatisticsManager(
    private val repository: GameDataRepository
) {
    
    suspend fun recordGameEnd(
        gameRecord: GameRecord,
        gameConfig: GameConfig
    ) {
        // ä¿å­˜æ¸¸æˆè®°å½•
        repository.saveGameRecord(gameRecord)
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        val currentStats = repository.getPlayerStatistics()
        val updatedStats = updateStatistics(currentStats, gameRecord, gameConfig)
        repository.updateStatistics(updatedStats)
    }
    
    private fun updateStatistics(
        current: PlayerStatistics,
        record: GameRecord,
        config: GameConfig
    ): PlayerStatistics {
        return current.copy(
            totalGames = current.totalGames + 1,
            totalScore = current.totalScore + record.finalScore,
            highestScore = maxOf(current.highestScore, record.finalScore),
            totalPlayTime = current.totalPlayTime + record.playTime,
            averageScore = (current.totalScore + record.finalScore).toDouble() / (current.totalGames + 1),
            longestSnake = maxOf(current.longestSnake, record.maxSnakeLength),
            foodEaten = current.foodEaten + record.foodEaten,
            gamesByMode = current.gamesByMode + (config.gameMode to (current.gamesByMode[config.gameMode] ?: 0) + 1),
            gamesByDifficulty = current.gamesByDifficulty + (config.difficulty to (current.gamesByDifficulty[config.difficulty] ?: 0) + 1)
        )
    }
}
```

### æˆå°±ç³»ç»Ÿè®¾è®¡
```kotlin
// æˆå°±å®šä¹‰
sealed class Achievement(
    val id: String,
    val name: String,
    val description: String,
    val icon: String,
    val points: Int
) {
    abstract fun checkUnlock(statistics: PlayerStatistics, record: GameRecord?): Boolean
    
    // åˆ†æ•°ç›¸å…³æˆå°±
    class FirstScore(points: Int) : Achievement(
        "first_score", "åˆå‡ºèŒ…åº", "è·å¾—ç¬¬ä¸€åˆ†", "ğŸ¯", points
    ) {
        override fun checkUnlock(statistics: PlayerStatistics, record: GameRecord?): Boolean {
            return statistics.totalScore > 0
        }
    }
    
    class HighScore(private val targetScore: Int, points: Int) : Achievement(
        "high_score_$targetScore", "é«˜åˆ†è¾¾äºº", "å•å±€å¾—åˆ†è¾¾åˆ°$targetScore", "ğŸ†", points
    ) {
        override fun checkUnlock(statistics: PlayerStatistics, record: GameRecord?): Boolean {
            return statistics.highestScore >= targetScore
        }
    }
    
    // æ¸¸æˆæ¬¡æ•°ç›¸å…³æˆå°±
    class GameCount(private val targetCount: Int, points: Int) : Achievement(
        "game_count_$targetCount", "åšæŒä¸æ‡ˆ", "ç´¯è®¡æ¸¸æˆ${targetCount}å±€", "ğŸ®", points
    ) {
        override fun checkUnlock(statistics: PlayerStatistics, record: GameRecord?): Boolean {
            return statistics.totalGames >= targetCount
        }
    }
    
    // ç‰¹æ®Šæˆå°±
    class PerfectGame : Achievement(
        "perfect_game", "å®Œç¾æ¸¸æˆ", "ä¸€å±€æ¸¸æˆä¸­ä¸æ’å¢™", "âœ¨", 50
    ) {
        override fun checkUnlock(statistics: PlayerStatistics, record: GameRecord?): Boolean {
            return record?.gameOverReason != GameState.GameOverReason.WALL_COLLISION
        }
    }
}

// æˆå°±ç®¡ç†å™¨
class AchievementManager(
    private val repository: GameDataRepository
) {
    
    private val allAchievements = listOf(
        Achievement.FirstScore(10),
        Achievement.HighScore(50, 20),
        Achievement.HighScore(100, 30),
        Achievement.HighScore(200, 50),
        Achievement.GameCount(10, 15),
        Achievement.GameCount(50, 25),
        Achievement.GameCount(100, 40),
        Achievement.PerfectGame()
    )
    
    suspend fun checkAchievements(
        gameRecord: GameRecord,
        gameConfig: GameConfig
    ): List<Achievement> {
        val statistics = repository.getPlayerStatistics()
        val unlockedAchievements = mutableListOf<Achievement>()
        
        allAchievements.forEach { achievement ->
            if (!statistics.achievements.contains(achievement.id) && 
                achievement.checkUnlock(statistics, gameRecord)) {
                unlockedAchievements.add(achievement)
            }
        }
        
        // æ›´æ–°å·²è§£é”æˆå°±
        if (unlockedAchievements.isNotEmpty()) {
            val newAchievements = statistics.achievements + unlockedAchievements.map { it.id }
            val updatedStats = statistics.copy(achievements = newAchievements)
            repository.updateStatistics(updatedStats)
        }
        
        return unlockedAchievements
    }
}
```

## ğŸ“Š æ•°æ®æ¨¡å‹è®¾è®¡

### æ¸¸æˆè®°å½•æ¨¡å‹
```kotlin
@Serializable
data class GameRecord(
    val id: String = UUID.randomUUID().toString(),
    val timestamp: Long = System.currentTimeMillis(),
    val gameMode: GameMode,
    val difficulty: Difficulty,
    val finalScore: Int,
    val maxSnakeLength: Int,
    val playTime: Long, // æ¯«ç§’
    val foodEaten: Int,
    val effectsUsed: Int,
    val gameOverReason: GameState.GameOverReason,
    val replayData: ReplayData? = null
)

@Serializable
data class ReplayData(
    val moves: List<ReplayMove>,
    val foodPositions: List<Position>,
    val gameConfig: GameConfig
)

@Serializable
data class ReplayMove(
    val timestamp: Long,
    val direction: Direction,
    val snakePosition: List<Position>
)
```

### æ’è¡Œæ¦œæ¨¡å‹
```kotlin
@Serializable
data class LeaderboardEntry(
    val playerName: String,
    val score: Int,
    val gameMode: GameMode,
    val difficulty: Difficulty,
    val timestamp: Long,
    val rank: Int = 0
)

data class Leaderboard(
    val entries: List<LeaderboardEntry>,
    val playerRank: Int?,
    val totalPlayers: Int
)
```

## ğŸ¨ UIç»„ä»¶è®¾è®¡

### ç»Ÿè®¡ç•Œé¢ç»„ä»¶
```kotlin
@Composable
fun StatisticsScreen(
    statistics: PlayerStatistics,
    onBackClick: () -> Unit
) {
    LazyColumn {
        item { OverviewCard(statistics) }
        item { ScoreChart(statistics) }
        item { GameModeBreakdown(statistics) }
        item { RecentGamesCard(statistics) }
        item { AchievementsPreview(statistics) }
    }
}

@Composable
fun OverviewCard(statistics: PlayerStatistics) {
    Card {
        Column {
            StatisticItem("æ€»æ¸¸æˆæ•°", statistics.totalGames.toString())
            StatisticItem("æœ€é«˜åˆ†", statistics.highestScore.toString())
            StatisticItem("å¹³å‡åˆ†", "%.1f".format(statistics.averageScore))
            StatisticItem("æ€»æ¸¸æˆæ—¶é—´", formatPlayTime(statistics.totalPlayTime))
        }
    }
}
```

## ğŸ”§ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### æ•°æ®å­˜å‚¨ä¼˜åŒ–
1. **æ‰¹é‡æ“ä½œ**: å‡å°‘é¢‘ç¹çš„I/Oæ“ä½œ
2. **æ•°æ®å‹ç¼©**: ä½¿ç”¨JSONå‹ç¼©å­˜å‚¨å¤§é‡æ•°æ®
3. **ç¼“å­˜æœºåˆ¶**: å†…å­˜ç¼“å­˜å¸¸ç”¨æ•°æ®
4. **å¼‚æ­¥æ“ä½œ**: æ‰€æœ‰å­˜å‚¨æ“ä½œä½¿ç”¨åç¨‹

### ç»Ÿè®¡è®¡ç®—ä¼˜åŒ–
1. **å¢é‡æ›´æ–°**: åªè®¡ç®—å˜åŒ–çš„éƒ¨åˆ†
2. **é¢„è®¡ç®—**: é¢„å…ˆè®¡ç®—å¸¸ç”¨ç»Ÿè®¡æŒ‡æ ‡
3. **åˆ†é¡µåŠ è½½**: å¤§é‡æ•°æ®åˆ†é¡µå¤„ç†
4. **åå°è®¡ç®—**: å¤æ‚ç»Ÿè®¡åœ¨åå°çº¿ç¨‹è®¡ç®—

## ğŸ“… æ—¶é—´å®‰æ’

### ç¬¬1-2å¤©ï¼šæ•°æ®æŒä¹…åŒ–åŸºç¡€
- å®ç°è·¨å¹³å°å­˜å‚¨æŠ½è±¡
- åˆ›å»ºæ•°æ®ä»“åº“å’ŒåŸºç¡€æ•°æ®æ¨¡å‹
- å®ç°è®¾ç½®å’Œæ¸¸æˆè®°å½•çš„ä¿å­˜åŠ è½½

### ç¬¬3-4å¤©ï¼šç»Ÿè®¡ç³»ç»Ÿå¼€å‘
- å¼€å‘ç»Ÿè®¡ç®¡ç†å™¨å’Œåˆ†æå™¨
- åˆ›å»ºç»Ÿè®¡ç•Œé¢å’Œå›¾è¡¨ç»„ä»¶
- å®ç°æ•°æ®å¯è§†åŒ–åŠŸèƒ½

### ç¬¬5-6å¤©ï¼šæˆå°±ç³»ç»Ÿå®ç°
- è®¾è®¡æˆå°±å®šä¹‰å’Œæ£€æŸ¥é€»è¾‘
- å®ç°æˆå°±ç®¡ç†å™¨å’Œé€šçŸ¥ç³»ç»Ÿ
- åˆ›å»ºæˆå°±ç•Œé¢å’Œè§£é”åŠ¨ç”»

### ç¬¬7-8å¤©ï¼šæ’è¡Œæ¦œå’Œå›æ”¾
- å¼€å‘æ’è¡Œæ¦œç³»ç»Ÿå’Œç•Œé¢
- å®ç°æ¸¸æˆå›æ”¾å½•åˆ¶å’Œæ’­æ”¾
- æ·»åŠ æ•°æ®å¯¼å‡ºå’Œåˆ†äº«åŠŸèƒ½

### ç¬¬9-10å¤©ï¼šé›†æˆæµ‹è¯•å’Œä¼˜åŒ–
- å…¨é¢æµ‹è¯•æ•°æ®æŒä¹…åŒ–åŠŸèƒ½
- æ€§èƒ½ä¼˜åŒ–å’Œå†…å­˜ç®¡ç†
- è·¨å¹³å°å…¼å®¹æ€§éªŒè¯

## ğŸ¯ æˆåŠŸæ ‡å‡†

### åŠŸèƒ½å®Œæ•´æ€§
- âœ… æ•°æ®æŒä¹…åŒ–ç³»ç»Ÿå®Œå…¨å¯ç”¨
- âœ… ç»Ÿè®¡åŠŸèƒ½å‡†ç¡®å®Œæ•´
- âœ… æˆå°±ç³»ç»Ÿæ­£å¸¸å·¥ä½œ
- âœ… æ’è¡Œæ¦œåŠŸèƒ½å®Œå–„

### æ€§èƒ½æŒ‡æ ‡
- âœ… æ•°æ®ä¿å­˜/åŠ è½½æ—¶é—´<100ms
- âœ… ç»Ÿè®¡è®¡ç®—æ—¶é—´<200ms
- âœ… å†…å­˜ä½¿ç”¨å¢é•¿<20MB
- âœ… åº”ç”¨å¯åŠ¨æ—¶é—´å¢åŠ <500ms

### ç”¨æˆ·ä½“éªŒ
- âœ… æ•°æ®æ°¸ä¸ä¸¢å¤±
- âœ… ç»Ÿè®¡ä¿¡æ¯ç›´è§‚æ˜“æ‡‚
- âœ… æˆå°±ç³»ç»Ÿæœ‰è¶£æ¿€åŠ±
- âœ… ç•Œé¢å“åº”æµç•…

---

**å‡†å¤‡å¼€å§‹é˜¶æ®µ3çš„æ•°æ®ç®¡ç†ä¹‹æ—…ï¼** ğŸš€

è®©æˆ‘ä»¬ä¸ºè´ªåƒè›‡æ¸¸æˆæ„å»ºå®Œæ•´çš„æ•°æ®ç”Ÿæ€ç³»ç»Ÿï¼Œæä¾›æ·±åº¦çš„æ¸¸æˆä½“éªŒå’Œç”¨æˆ·ä»·å€¼ï¼